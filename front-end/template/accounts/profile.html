{% extends 'base.html' %}
{% load static %}
{% block title %} | Profilo di {{ user_profile.first_name }}{% endblock %}
{% block style %}
    <link rel="stylesheet" href="{% static 'css/accounts/profile.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
{% endblock %}

{% block content %}

<div class="page-wrapper">
    <div class="main-content-area">
        <header class="top-header" style="display: none;">
        </header>

        <div class="profile-main-section">
            <div class="profile-page-container">

                <div class="cover-photo-section">
                    {% if user_profile.cover_picture %}
                        <img src="{{ user_profile.cover_picture.url }}" alt="Cover Photo" class="cover-image">
                    {% else %}
                        <div class="cover-placeholder"></div>
                    {% endif %}
                    {% if is_owner %}
                        <div class="cover-overlay">
                            <button class="edit-cover-btn" aria-label="Modifica foto di copertina" title="Modifica foto di copertina">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>
                        <input type="file" id="cover-upload" name="cover_picture" accept="image/*" style="display: none;">
                    {% endif %}
                </div>

                <div class="profile-header-section">
                    <div class="profile-avatar-container">
                        <img src="{% if user_profile.profile_picture %}{{ user_profile.profile_picture.url }}{% else %}{% static 'img/default.jpg' %}{% endif %}" alt="Foto Profilo" class="profile-avatar">
                        {% if is_owner %}
                            <div class="avatar-overlay">
                                <button class="edit-avatar-btn" aria-label="Modifica foto profilo" title="Modifica foto profilo">
                                    <i class="fas fa-camera"></i>
                                </button>
                            </div>
                            <input type="file" id="avatar-upload" name="profile_picture" accept="image/*" style="display: none;">
                        {% endif %}
                    </div>

                    <div class="profile-info-and-actions">
                        <h1 class="profile-name">{{ user_profile.first_name }} {{ user_profile.last_name }}{% if user_profile.age %}, {{ user_profile.age }}{% endif %}</h1>
                        <p class="location" id="geolocation">
                            <i class="fas fa-map-marker-alt"></i>
                            {% if user_profile.location %}
                                {{ user_profile.location }}
                            {% endif %}
                        </p>
                        {% if is_owner %}
                            <div class="profile-actions">
                                <button id="edit-profile-btn" class="btn btn-primary">Modifica Profilo</button>
                                <button id="public-preview-btn" class="btn btn-secondary">Anteprima Pubblica</button>
                            </div>
                        {% else %}
                            <div class="profile-actions">
                                <button class="btn btn-primary">Mi Piace</button>
                                <button class="btn btn-secondary">Messaggia</button>
                            </div>
                        {% endif %}
                    </div>
                </div>

                {% if is_owner %}
                    <div id="status-message-box" class="hidden p-3 mb-4 rounded-lg text-sm text-center font-medium"></div>
                {% endif %}

                <div id="my-profile-view" class="profile-content-section {% if not is_owner %}hidden{% endif %}">
                    <div class="bio-section card">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-800">Biography</h3>
                        <textarea
                            id="bio-textarea"
                            maxlength="255"
                            readonly
                        >{{ user_profile.biography|default:"Scrivi qualcosa di te per far conoscere la tua personalità unica!" }}</textarea>
                        <div class="flex justify-between items-center mt-4">
                            <button
                                id="edit-bio-btn"
                                class="btn-edit-bio bg-blue-600"
                                data-save-url="{% url 'accounts:update_bio' %}"
                            >
                                Modifica
                            </button>
                            <div id="char-count" style="font-size: 0.8em; color: #666; text-align: right; margin-top: 5px;">0/255</div>
                        </div>
                    </div>

                    <div class="profile-details-grid">
                        <div class="detail-item card">
                            <i class="fas fa-star icon-interest"></i>
                            <h4>Interessi:</h4>
                            {% if user_preferences %}
                                <p>{{ user_preferences.get_active_interests_count|default:"0" }}</p>
                            {% else %}
                                <p>N/A</p>
                            {% endif %}
                        </div>
                        <div class="detail-item card">
                            <i class="fas fa-pizza-slice icon-hobby"></i>
                            <h4>Hobbies:</h4>
                            <p>{{ user_profile.hobbies_count|default:"0" }}</p>
                        </div>
                        <div class="detail-item card">
                            <i class="fas fa-wine-glass icon-lifestyle"></i>
                            <h4>Stile di Vita:</h4>
                            <p>{{ user_profile.lifestyle_info|default:"N/A" }}</p>
                        </div>
                    </div>

                    <div class="profile-tabs card">
                        <div class="tab-buttons">
                            <button class="tab-button active" data-tab="user-stats">Statistiche Utente</button>
                            <button class="tab-button" data-tab="user-posts">Post Utente</button>
                            <button class="tab-button" data-tab="photo-gallery">Galleria Foto</button>
                        </div>
                        <div class="tab-content-wrapper">
                            <div id="user-stats" class="tab-content active">
                                <h2>Le Tue Statistiche</h2>
                                {% if user_stats %}
                                    <div class="stats-grid">
                                        <div class="stat-item-detailed">
                                            <i class="fas fa-heart-pulse"></i>
                                            <p><strong>Match Totali:</strong> {{ user_stats.match_counter|default:"0" }}</p>
                                        </div>
                                        <div class="stat-item-detailed">
                                            <i class="fas fa-thumbs-up"></i>
                                            <p><strong>Like Inviati:</strong> {{ user_stats.like_sent_counter|default:"0" }}</p>
                                        </div>
                                        <div class="stat-item-detailed">
                                            <i class="fas fa-arrow-right-arrow-left"></i>
                                            <p><strong>Like Ricevuti:</strong> {{ user_stats.like_recv_counter|default:"0" }}</p>
                                        </div>
                                    </div>

                                    <div class="stats-grid">
                                        <div class="stat-item-detailed">
                                            <i class="fas fa-comment-dots"></i>
                                            <p><strong>Dislike Inviati:</strong> {{ user_stats.dislike_sent_counter|default:"0" }}</p>
                                        </div>
                                        <div class="stat-item-detailed">
                                            <i class="fas fa-percent"></i>
                                            {% if user_stats.like_sent_counter > 0 %}
                                                <p><strong>Tasso di Match:</strong> {{ user_stats.match_rate|floatformat:2 }}%</p>
                                            {% else %}
                                                <p><strong>Tasso di Match:</strong> N/D</p>
                                            {% endif %}
                                        </div>
                                        <div class="stat-item-detailed">
                                            <i class="fas fa-calendar-alt"></i>
                                            <p><strong>Iscritto dal:</strong> {{ user_stats.registration_day|date:"d/m/Y" }}</p>
                                        </div>
                                    </div>
                                {% else %}
                                    <p>Statistiche non disponibili per questo utente.</p>
                                {% endif %}
                            </div>

                            <div id="user-posts" class="tab-content">
                                <h2>I Miei Post</h2>
                                <div class="create-post-area">
                                    <textarea placeholder="Cosa ti passa per la mente, {{ user_profile.first_name }}?"></textarea>
                                    <div class="options">
                                        <button><i class="fas fa-camera"></i> Foto/Video</button>
                                        <button><i class="fas fa-smile"></i> Umore/Attività</button>
                                    </div>
                                </div>
                                <div class="posts-list">
                                    {% for post in user_profile.post_set.all %}
                                    <div class="user-post">
                                        <div class="post-header">
                                            <img src="{% if user_profile.profile_picture %}{{ user_profile.profile_picture.url }}{% else %}{% static 'img/default.jpg' %}{% endif %}" alt="Foto Profilo">
                                            <div>
                                                <h4>{{ user_profile.first_name }} {{ user_profile.last_name }}</h4>
                                                <span class="post-date">{{ post.date|date:"d M H:i" }}</span>
                                            </div>
                                        </div>
                                        <p class="post-content">{{ post.content }}</p>
                                        {% if post.image %}
                                        <img src="{{ post.image.url }}" alt="Post Image" class="post-image">
                                        {% endif %}
                                        <div class="post-actions">
                                            <button><i class="fas fa-heart"></i> Mi Piace</button>
                                            <button><i class="fas fa-comment"></i> Commenta</button>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <p class="no-content-message">Nessun post pubblicato ancora. Condividi qualcosa di te!</p>
                                    {% endfor %}
                                </div>
                            </div>

                            <div id="photo-gallery" class="tab-content">
                                <h2>Galleria Foto</h2>
                                <div class="photo-grid">
                                    {% for photo in user_profile.gallery_photos.all %}
                                    <div class="photo-item">
                                        <img src="{{ photo.image.url }}" alt="Foto Galleria">
                                    </div>
                                    {% empty %}
                                    <p class="no-content-message">Nessuna foto nella galleria. Aggiungi le tue foto migliori!</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="public-preview-view" class="profile-content-section {% if is_owner %}hidden{% endif %}">
                    <div class="bio-section card">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-800">Biography</h3>
                        <p id="public-bio-text" class="w-full p-3 border border-gray-200 rounded-md bg-gray-50 text-gray-700 min-h-[100px]">{{ user_profile.biography|default:"Nessuna biografia disponibile." }}</p>
                    </div>

                    <div class="profile-details-grid">
                        <div class="detail-item card">
                            <i class="fas fa-star icon-interest"></i>
                            <h4>Interessi:</h4>
                            {% if user_preferences %}
                                <p>{{ user_preferences.get_active_interests_count|default:"0" }}</p>
                            {% else %}
                                <p>N/A</p>
                            {% endif %}
                        </div>
                        <div class="detail-item card">
                            <i class="fas fa-pizza-slice icon-hobby"></i>
                            <h4>Hobbies:</h4>
                            <p>{{ user_profile.hobbies_count|default:"0" }}</p>
                        </div>
                        <div class="detail-item card">
                            <i class="fas fa-wine-glass icon-lifestyle"></i>
                            <h4>Stile di Vita:</h4>
                            <p>{{ user_profile.lifestyle_info|default:"N/A" }}</p>
                        </div>
                    </div>

                    <div class="profile-tabs card">
                        <div class="tab-buttons">
                            <button class="tab-button active" data-tab="public-user-posts">Post Utente</button>
                            <button class="tab-button" data-tab="public-photo-gallery">Galleria Foto</button>
                        </div>
                        <div class="tab-content-wrapper">
                            <div id="public-user-posts" class="tab-content active">
                                <h2>Post Recenti</h2>
                                <div class="posts-list">
                                    {% for post in user_profile.post_set.all %}
                                    <div class="user-post">
                                        <div class="post-header">
                                            <img src="{% if user_profile.profile_picture %}{{ user_profile.profile_picture.url }}{% else %}{% static 'img/default.jpg' %}{% endif %}" alt="Foto Profilo">
                                            <div>
                                                <h4>{{ user_profile.first_name }} {{ user_profile.last_name }}</h4>
                                                <span class="post-date">{{ post.date|date:"d M H:i" }}</span>
                                            </div>
                                        </div>
                                        <p class="post-content">{{ post.content }}</p>
                                        {% if post.image %}
                                        <img src="{{ post.image.url }}" alt="Post Image" class="post-image">
                                        {% endif %}
                                        <div class="post-actions">
                                            <button><i class="fas fa-heart"></i> Mi Piace</button>
                                            <button><i class="fas fa-comment"></i> Commenta</button>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <p class="no-content-message">Nessun post pubblico disponibile.</p>
                                    {% endfor %}
                                </div>
                            </div>

                            <div id="public-photo-gallery" class="tab-content">
                                <h2>Galleria Pubblica</h2>
                                <div class="photo-grid">
                                    {% for photo in user_profile.gallery_photos.all %}
                                    <div class="photo-item">
                                        <img src="{{ photo.image.url }}" alt="Foto Galleria">
                                    </div>
                                    {% empty %}
                                    <p class="no-content-message">Nessuna foto pubblica disponibile.</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block footer %}
{% include "footer.html" %}
{% endblock %}

{% block script %}
    <script src="{% static 'js/accounts/profile_tabs.js' %}"></script>
    {% if is_owner %}
        <div id="profile-data-container" data-upload-url="{% url 'accounts:upload_photo' %}" style="display: none;"></div>
        <script src="{% static 'js/accounts/profile.js' %}"></script>
    {% endif %}
    <script src="{% static 'js/accounts/geolocation.js' %}"></script>
{% endblock %}