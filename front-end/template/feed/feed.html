{% extends 'base.html' %}
{% load static %}
{% block title %} | Feed{% endblock %}
{% block style %}
    <link rel="stylesheet" href="{% static 'css/feed/feed.css' %}"/>
{% endblock %}

{% block content %}
<div class="feed-layout">

    <div class="feed-left-sidebar">
        <div class="chat-list-sidebar">
            <h2>Chats with Matches</h2>
            <div class="search-bar">
                <input type="text" id="search-bar" placeholder="Search chat with your Matches">
            </div>
            <div class="chats" id="chats">
                {% for user in matched_users %}
                    <div class="chat-item" onclick="enterChat('{{ user.username }}')">
                        <div class="chat-avatar">
                            <img class="chat-avatar" src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}{% static 'img/default.jpg' %}{% endif %}" alt="Foto Profilo"> 
                        </div>

                        <div class="chat-info">
                            <div class="chat-name">{{ user.username }}</div>
                        </div>
                        <div class="chat-timestamp">02:01 TODO</div>
                    </div>
                {% endfor %}
            </div>
        </div> 
            
        <div class="feed-filters-sidebar">
            <h1>Filters</h1>
        </div>
    </div>
    
    <div class="feed-feed-container">
        {% for user in pending_users_arrived %}
            <div class="feed-post">
                <div class="feed-post-header">
                    
                    <a href="#">
                    
                        <img src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}{% static 'img/default.jpg' %}{% endif %}" alt="User Profile Picture" class="feed-profile-pic">

                    </a>
                    <button class="feed-username">{{ user.username }}</button>
                </div>
                <div class="feed-post-image">
                    <img src="https://picsum.photos/600/400?random=1" alt="Post Image">
                </div>

                <div class="feed-post-actions">
                    <form action="{% url 'feed' %}" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="liked_username" value="{{ user.username }}">
                        <button type="submit" class="feed-action-button feed-like-button"><i class="far fa-heart"></i>Like</button>
                    </form>
                    <form action="{% url 'feed' %}" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="disliked_username" value="{{ user.username }}">
                        <button type="submit" class="feed-action-button feed-dislike-button"><i class="far fa-thumbs-down"></i>Dont Like</button>
                    </form>
                </div>
            </div>
        {% endfor %}

        {% for user in users %}
            {% if user not in pending_users_arrived and user not in matched_users and user not in pending_users_sent and user != request.user %}
                <div class="feed-post">
                    <div class="feed-post-header">
                            
                        <a href="{% url 'accounts:profile' user.username %}">
                            <img src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}{% static 'img/default.jpg' %}{% endif %}" alt="User Profile Picture" class="feed-profile-pic">
                            </a>
                        <button class="feed-username">{{ user.username }}</button>
                    </div>
                    <div class="feed-post-image">
                    {% with latest_post=user.post_set.first %}
                        {% if latest_post and latest_post.text %}
                            <div class="feed-post-caption">
                                <p> {{ latest_post.text }}</p>
                            </div>
                        {% endif %}
                    {% endwith %}

                    {% with latest_post=user.post_set.first %}
                        {% if latest_post and latest_post.post_pic %}
                            <img src="{{ latest_post.post_pic.url }}" alt="Post Image">
                        {% else %}
                            <img src="https://picsum.photos/600/400?random=1" alt="Post Image">
                        {% endif %}
                    {% endwith %}
                    </div>
                    
                    <div class="feed-post-actions">
                        <form action="{% url 'feed' %}" method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="liked_username" value="{{ user.username }}">
                            <button type="submit" class="feed-action-button feed-like-button"><i class="far fa-heart"></i>Like</button>
                        </form>
                        <form action="{% url 'feed' %}" method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="disliked_username" value="{{ user.username }}">
                            <button type="submit" class="feed-action-button feed-dislike-button"><i class="far fa-thumbs-down"></i>Dont Like</button>
                        </form>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block footer %}
{% endblock %}

{% block script %}
<script type="text/javascript">
    function enterChat(username) {
        window.location.href = `/chat/${username}`;
    }
</script>

<script>
    const searchInput = document.getElementById("search-bar")
    const chatsDiv = document.getElementById("chats")

    searchInput.addEventListener("input", function() {
        const url = `/feed/search_chat/?q=${encodeURIComponent(searchInput.value)}`;

        fetch(url, {
            method: 'GET'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            displayOutput(data.searched_users)
        })
    })

    function displayOutput(users) {
        chatsDiv.innerHTML = ""

        if (users.length > 0) {
            users.forEach(username => {
                chatsDiv.innerHTML += `
                    <div class="chat-item" onclick="enterChat('${username}')">
                        <div class="chat-avatar">
                            <img class="chat-avatar" src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}{% static 'img/default.jpg' %}{% endif %}" alt="Foto Profilo"> 
                        </div>

                        <div class="chat-info">
                            <div class="chat-name">${username}</div>
                        </div>
                        <div class="chat-timestamp">02:01 TODO</div>
                    </div>
                `
            })
        }
    }

</script>
{% endblock %}