{% extends 'base_feed_chat.html' %}
{% load static %}
{% block title %} | Chat with {{ chat_user.username }}{% endblock %}
{% block style %}
    <link rel="stylesheet" href="{% static 'css/chat/chat.css' %}"/>
{% endblock %}
{% block content %}

{# Main container for the overall chat application layout #}
<div class="chat-layout">
    
    {# Left Sidebar for Chat List #}
    <div class="chat-list-sidebar">
        <h2>Chats with Matches</h2>
        <div class="search-bar">
            <input type="text" placeholder="Search chat with your Matches">
        </div>
        <div class="chats">
            {% for user in matched_users %}
                <div class="chat-item" onclick="enterChat('{{ user.username }}')">
                    <div class="chat-avatar">
                        <img class="chat-avatar" src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}{% static 'img/default.jpg' %}{% endif %}" alt="Foto Profilo"> 
                    </div>

                    <div class="chat-info">
                        <div class="chat-name">{{ user.username }}</div>
                    </div>
                    <div class="chat-timestamp">02:01 TODO</div>
                    {# <a href="{% url 'chatroom' user.username %}" class="feed-start-chat-button">Chat</a> #}
                </div>
            {% endfor %}
        </div>
    </div>

    {# Main Chat Area #}
    <div class="main-chat-area">
        {# Chat Header #}
        <div class="chat-header-main">
            <div class="chat-header-info">
                <div class="chat-avatar-main">
                    <img class="chat-avatar" src="{% if chat_user.profile_picture %}{{ chat_user.profile_picture.url }}{% else %}{% static 'img/default.jpg' %}{% endif %}" alt="Foto Profilo">
                </div>
                <div class="chat-details">
                    <h3>{{ chat_user.username }}</h3>
                    {% if chat_user.online %}
                        <p>online</p>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Message container - will scroll #}
        <div id="messages" class="messages-container">
            {% for message in messages %}
                {# Message container: Aligns the bubble left or right #}
                <div class="message-container {% if message.user_sender.username == request.user.username %}my-message{% else %}other-message{% endif %}">
                    {# The message bubble itself #}
                    <div class="message-bubble">
                        {# Show username only for other users in group chats #}
                        {% if message.user_sender.username != request.user.username and room.is_group %} {# Assuming room has an is_group attribute #}
                            <div class="message-username">{{ message.user_sender.username }}</div>
                        {% endif %}
                        <div class="message-text">{{ message.message_payload }}</div>
                        {# Timestamp inside the bubble, aligned right #}
                        <div class="message-timestamp">{{ message.time_stamp|date:"H:i" }}</div> {# Format time as HH:MM #}
                    </div>
                </div>
            {% endfor %}
        </div>

        {# Input where to write messages - fixed at bottom #}
        <form id="chat_form" class="message-input-form">
            <input type="text" name="message" placeholder="Type a message..." autocomplete="off">
            <button type="submit" class="send-button">
                {# SVG icon for send (paper airplane) #}
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="send-icon">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </form>

    </div> {# End main-chat-area #}

</div> {# End chat-layout #}

{% endblock %}

{% block script %}
<script type="text/javascript">
    function enterChat(username) {
        window.location.href = `/chat/${username}`;
    }

    // Existing JavaScript remains the same for handling messages
    function formatTime(timeString) {
        const date = new Date(timeString);
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    roomName = "{{ room.name }}"
    username = "{{ request.user.username }}"

    let url = `ws://${window.location.host}/ws/${roomName}/`

    const chatSocket = new WebSocket(url)

    chatSocket.onmessage = function(event){
        let data = JSON.parse(event.data)
        console.log("Data: ", data)

        let formatedTime = formatTime(data.time_stamp)
        if (data.type === "chat") {
            let messages = document.getElementById("messages");

            let messageClass = (data.username === username) ? "my-message" : "other-message";

            let html = `<div class="message-container ${messageClass}">
                            <div class="message-bubble">
                                <div class="message-text">${data.message}</div>
                                <div class="message-timestamp">${formatedTime}</div>
                            </div>
                        </div>`;

            messages.insertAdjacentHTML("beforeend", html);

            messages.scrollTop = messages.scrollHeight;
        }
    }

    let form = document.getElementById("chat_form")

    form.addEventListener("submit", (event)=> {
        event.preventDefault()

        let message = event.target.message.value

        chatSocket.send(JSON.stringify({
            "username":username,
            "message":message
        }))

        form.reset()
    })

    // Scroll to the bottom of the messages when the page loads
    window.onload = function() {
        const messagesContainer = document.getElementById("messages");
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    };

</script>
{% endblock %}