{% extends 'base.html' %}
{% load static %}
{% block title %} | Chat with {{ chat_user }}{% endblock %}
{% block style %}
    <link rel="stylesheet" href="{% static 'css/chat/chat.css' %}"/>
{% endblock %}
{% block content %}

<div class="chat-container">

    <div class="chat-header">
        <h2>{{ chat_user }}</h2> 
    </div>

    <div id="messages" class="messages-container">
        {% for message in messages %}
            <div class="message-container {% if message.user_sender.username == request.user.username %}my-message{% else %}other-message{% endif %}">
                <div class="message-bubble">
                    {% if message.user_sender.username != request.user.username and room.is_group %}
                        <div class="message-username">{{ message.user_sender.username }}</div>
                    {% endif %}
                    <div class="message-text">{{ message.message_payload }}</div>
                    <div class="message-timestamp">{{ message.time_stamp|date:"H:i" }}</div>
                </div>
            </div>
        {% endfor %}
    </div>

    <form id="chat_form" class="message-input-form">
        <input type="text" name="message" placeholder="Type a message..." autocomplete="off">
        <button type="submit" class="send-button">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="send-icon">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        </button>
    </form>

</div>
{% endblock %}

{% block script %}

<script type="text/javascript">

    function formatTime(timeString) {
        const date = new Date(timeString);
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    roomName = "{{ room.name }}"
    username = "{{ request.user.username }}"

    let url = `ws://${window.location.host}/ws/${roomName}/`

    const chatSocket = new WebSocket(url)

    chatSocket.onmessage = function(event){
        let data = JSON.parse(event.data)
        console.log("Data: ", data)

        let formatedTime = formatTime(data.time_stamp)
        if (data.type === "chat") {
            let messages = document.getElementById("messages");
                        
            let messageClass = (data.username === username) ? "my-message" : "other-message";

            let html = `<div class="message-container ${messageClass}">
                                <div class="message-bubble">
                                    <div class="message-text">${data.message}</div>
                                    <div class="message-timestamp">${formatedTime}</div>
                                </div>
                            </div>`;

            messages.insertAdjacentHTML("beforeend", html);
            
            messages.scrollTop = messages.scrollHeight;

        }
    }

    let form = document.getElementById("chat_form")

    form.addEventListener("submit", (event)=> {
        event.preventDefault()

        let message = event.target.message.value

        chatSocket.send(JSON.stringify({
            "username":username,
            "message":message           
        }))
        
        form.reset()
    })

</script>
{% endblock %}