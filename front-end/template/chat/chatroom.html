{% extends 'base.html' %}
{% load static %}
{% block title %} | Chat with {{ chat_user }}{% endblock %}
{% block style %}
    {# Link to the new CSS file #}
	<link rel="stylesheet" href="{% static 'css/chat/chat.css' %}"/>
{% endblock %}
{% block content %}

{# Main container for the chat layout #}
<div class="chat-container">

    {# Optional: Header bar (replace h1 or style it) #}
    <div class="chat-header">
        <h2>{{ room.name }}</h2> {# Or {{ chat_user.username }} for 1:1 chat #}
        {# Add status or profile picture here if you have them #}
    </div>

    {# container dei messaggi - will scroll #}
    <div id="messages" class="messages-container">
        {% for message in messages %}
            {# Message container: Aligns the bubble left or right #}
            <div class="message-container {% if message.user_sender.username == request.user.username %}my-message{% else %}other-message{% endif %}">
                {# The message bubble itself #}
                <div class="message-bubble">
                    {# Show username only for other users in group chats #}
                    {% if message.user_sender.username != request.user.username and room.is_group %} {# Assuming room has an is_group attribute #}
                        <div class="message-username">{{ message.user_sender.username }}</div>
                    {% endif %}
                    <div class="message-text">{{ message.message_payload }}</div>
                    {# Timestamp inside the bubble, aligned right #}
                    <div class="message-timestamp">{{ message.time_stamp|date:"H:i" }}</div> {# Format time as HH:MM #}
                </div>
            </div>
        {% endfor %}
    </div>

    {# input dove scrivere messaggi - fixed at bottom #}
    <form id="chat_form" class="message-input-form">
        <input type="text" name="message" placeholder="Type a message..." autocomplete="off">
        <button type="submit" class="send-button">
            {# SVG icon for send (paper airplane) #}
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="send-icon">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        </button>
    </form>

</div> {# End chat-container #}

{% endblock %}

{% block script %}

<script type="text/javascript">
    roomName = "{{ room.name }}"
    username = "{{ request.user.username }}"

    // protocollo://ip/<url_corrispondente_al_consumer_per_connettersi_a_server>
    let url = `ws://${window.location.host}/ws/${roomName}/`

    // crea oggetto socket che cerca di connettersi al Server su "url"
    const chatSocket = new WebSocket(url)

    // funzione che ascolta messaggi in arrivo dal Server (in formato JSON)
    chatSocket.onmessage = function(event){
        let data = JSON.parse(event.data)
        console.log("Data: ", data)

        // se messaggio ha type "chat" aggiungo messaggio nel div
        if (data.type === "chat") {
            let messages = document.getElementById("messages")

            let html =  `<div>`
                html +=     `<h5 style="display: inline-block;">${data.username}: </h5>`
                html +=     `<p style="display: inline-block;"> ${data.message} </p>`
                html +=     `<p style="display: inline-block;"> | ${data.time_stamp}</p>`
                html += `</div>`
            
            // "beforeend" fa append in fondo
            messages.insertAdjacentHTML("beforeend", html)
        }
    }

    // form per submit del messaggio
    let form = document.getElementById("chat_form")

    form.addEventListener("submit", (event)=> { //(event)=> {...} Ã¨ un Arrow Function
        event.preventDefault() // ?

        // contenuto input html del form
        let message = event.target.message.value

        // manda messaggio al server sulla socket (in formato JSON)
        chatSocket.send(JSON.stringify({
            "username":username,
            "message":message            
        }))
        
        // restetto il form in modo da poter resubmittare altri messaggi in futuro
        form.reset()
    })

</script>
{% endblock %}